#!/usr/bin/env bash

search_filter='
def find_item:
if $literal != "false" then 
    .overview.title == $pattern
  else
    .overview.title | test(".*\($pattern).*"; "i")
  end;
map(
    select(find_item) |
    "\(.uuid) \(.overview.title)"
) |
if (length == 0) then
    error("No matches found for /\($pattern)/i")
else 
    sort | .[]
end'

function fail() {
    echo "$@" >/dev/stderr
    exit 2
}

case "$1" in
    password|otp)
        set -o pipefail

        uuid="$(/usr/local/bin/op list items | jq --raw-output --arg literal "${3:-false}" --arg pattern "${2// /.*}" "$search_filter")" || fail "could not search for secret uuid "
        
        matches="$(( $(wc -l <<<"$uuid") + 0 ))"
        if [[ "$matches" -eq 0 ]] ; then
            fail "Found no matches :/"
        elif [[ "$matches" -gt 1 ]]; then
          if [[ -t 1 ]]; then
            PS3="Select an option (1-$(( $matches + 1 ))): "
            oldifs="$IFS"
            IFS=$'\n'
            names="$(cut -d " " -f 2- <<< "$uuid")"
            options=($names)
            IFS="$oldifs"
            select opt in "${options[@]}" "Quit"; do
              if [[ "$opt" == "Quit" ]] || [[ $REPLY == "$(( ${#options[@]} + 1 ))" ]]; then
                fail "Exiting"
              fi

              uuid=$(sed -n "${REPLY}p" <<<"$uuid")
              if [[ "$uuid" != "" ]]; then
                break
              fi
              >&2 echo "No such option"
            done
          else
            fail "Found multiple options ($matches) for secret:
$(awk '{$1 = "-"; print $0}' <<<"$uuid")"
          fi
        fi

        if [[ $1 == "password" ]]; then
          exec /usr/local/bin/op get item "${uuid%% *}" --fields ${4:-password}
        else
          exec /usr/local/bin/op get totp "${uuid%% *}" 
        fi
        ;;

    *)
        exec /usr/local/bin/op $@
esac
